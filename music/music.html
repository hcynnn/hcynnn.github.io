<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高性能音频播放器</title>
    <style>
        .audio-player {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: Arial, sans-serif;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .progress-container {
            margin: 10px 0;
        }
        progress {
            width: 100%;
            height: 8px;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        .status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .audio-selector {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
<div class="audio-player">
    <h2>高性能音频播放器</h2>

    <div class="audio-selector">
        <label>选择音频: </label>
        <select id="audioSelect">
            <option value="./assets/回来吧刺激战场伴奏.mp3">回来吧刺激战场伴奏.mp3</option>
            <option value="./assets/大东北我的家乡伴奏.mp3">大东北我的家乡伴奏.mp3</option>
        </select>
    </div>

    <div class="status" id="status">准备就绪</div>

    <!-- 音频元素 -->
    <audio id="audioPlayer" preload="metadata">
        <!-- 通过JavaScript动态加载源文件以提高兼容性 -->
        您的浏览器不支持HTML5音频播放，请<a href="./assets/回来吧刺激战场伴奏.mp3">点击下载音频</a>。
    </audio>

    <div class="controls">
        <button id="playBtn">播放</button>
        <button id="pauseBtn">暂停</button>
        <button id="restartBtn">重新开始</button>
        <button id="muteBtn">静音</button>
    </div>

    <div class="progress-container">
        <progress id="progressBar" value="0" max="100"></progress>
        <div class="time-display">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
        </div>
    </div>

    <div class="controls">
        <label>音量: </label>
        <input type="range" id="volumeSlider" min="0" max="100" value="100">
    </div>
</div>

<a href="./assets/回来吧刺激战场伴奏.mp3" download="回来吧刺激战场伴奏.mp3">下载 回来吧刺激战场伴奏.mp3</a>
<a href="./assets/大东北我的家乡伴奏.mp3" download="大东北我的家乡伴奏.mp3">下载 大东北我的家乡伴奏.mp3</a>

<script>
    class AudioPlayer {
        constructor() {
            this.audio = document.getElementById('audioPlayer');
            this.playBtn = document.getElementById('playBtn');
            this.pauseBtn = document.getElementById('pauseBtn');
            this.restartBtn = document.getElementById('restartBtn');
            this.muteBtn = document.getElementById('muteBtn');
            this.progressBar = document.getElementById('progressBar');
            this.volumeSlider = document.getElementById('volumeSlider');
            this.currentTimeDisplay = document.getElementById('currentTime');
            this.durationDisplay = document.getElementById('duration');
            this.status = document.getElementById('status');
            this.audioSelect = document.getElementById('audioSelect');

            this.init();
        }

        init() {
            // 设置初始音频源
            this.loadAudio(this.audioSelect.value);

            // 事件监听器
            this.setupEventListeners();

            // 性能优化：设置合理的预加载策略
            this.audio.preload = 'metadata';
        }

        setupEventListeners() {
            // 播放控制
            this.playBtn.addEventListener('click', () => this.play());
            this.pauseBtn.addEventListener('click', () => this.pause());
            this.restartBtn.addEventListener('click', () => this.restart());
            this.muteBtn.addEventListener('click', () => this.toggleMute());

            // 进度条控制
            this.audio.addEventListener('timeupdate', () => this.updateProgress());
            this.progressBar.addEventListener('click', (e) => this.seek(e));

            // 音量控制
            this.volumeSlider.addEventListener('input', () => {
                this.audio.volume = this.volumeSlider.value / 100;
            });

            // 音频选择
            this.audioSelect.addEventListener('change', (e) => {
                this.loadAudio(e.target.value);
            });

            // 音频事件
            this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
            this.audio.addEventListener('canplay', () => {
                this.status.textContent = '音频加载完成，可以播放';
            });
            this.audio.addEventListener('waiting', () => {
                this.status.textContent = '音频缓冲中...';
            });
            this.audio.addEventListener('error', (e) => {
                this.handleError('音频加载失败: ' + this.getErrorText(e.target.error));
            });
            this.audio.addEventListener('ended', () => {
                this.status.textContent = '播放结束';
                this.playBtn.textContent = '播放';
            });
        }

        loadAudio(src) {
            this.status.textContent = '加载音频中...';

            // 性能优化：先暂停当前音频
            this.pause();

            // 兼容性处理：检查浏览器支持情况
            if (!this.isAudioSupported()) {
                this.handleError('您的浏览器不支持HTML5音频播放');
                return;
            }

            // 设置新的音频源
            this.audio.src = src;

            // 性能优化：预加载元数据
            this.audio.load();
        }

        isAudioSupported() {
            const audio = document.createElement('audio');
            return !!(
                audio.canPlayType &&
                (audio.canPlayType('audio/mpeg') !== '' ||
                    audio.canPlayType('audio/mp3') !== '')
            );
        }

        async play() {
            try {
                await this.audio.play();
                this.playBtn.textContent = '播放中';
                this.status.textContent = '播放中';
            } catch (error) {
                this.handleError('播放失败: ' + error.message);
            }
        }

        pause() {
            this.audio.pause();
            this.playBtn.textContent = '播放';
            this.status.textContent = '已暂停';
        }

        restart() {
            this.audio.currentTime = 0;
            this.play();
        }

        toggleMute() {
            this.audio.muted = !this.audio.muted;
            this.muteBtn.textContent = this.audio.muted ? '取消静音' : '静音';
        }

        updateProgress() {
            if (this.audio.duration) {
                const progress = (this.audio.currentTime / this.audio.duration) * 100;
                this.progressBar.value = progress;

                // 更新时间显示
                this.currentTimeDisplay.textContent = this.formatTime(this.audio.currentTime);
            }
        }

        updateDuration() {
            if (this.audio.duration) {
                this.durationDisplay.textContent = this.formatTime(this.audio.duration);
            }
        }

        seek(e) {
            if (!this.audio.duration) return;

            const progressBar = this.progressBar.getBoundingClientRect();
            const clickPosition = (e.clientX - progressBar.left) / progressBar.width;
            this.audio.currentTime = clickPosition * this.audio.duration;
        }

        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        getErrorText(error) {
            if (!error) return '未知错误';

            switch (error.code) {
                case error.MEDIA_ERR_ABORTED:
                    return '音频加载被中止';
                case error.MEDIA_ERR_NETWORK:
                    return '网络错误';
                case error.MEDIA_ERR_DECODE:
                    return '音频解码错误';
                case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                    return '音频格式不支持';
                default:
                    return '未知错误';
            }
        }

        handleError(message) {
            console.error('Audio Player Error:', message);
            this.status.textContent = message;
            this.status.style.color = 'red';
        }
    }

    // 页面加载完成后初始化播放器
    document.addEventListener('DOMContentLoaded', () => {
        new AudioPlayer();
    });

    // 性能优化：页面可见性API，当页面不可见时暂停音频
    document.addEventListener('visibilitychange', () => {
        const audio = document.getElementById('audioPlayer');
        if (document.hidden) {
            audio.pause();
        }
    });
</script>
</body>
</html>